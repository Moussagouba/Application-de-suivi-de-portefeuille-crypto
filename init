#!/usr/bin/env python3
"""
Script d'initialisation de la base de donn√©es pour l'application Portefeuille Crypto
"""

import os
from app import app, db
from models import User, Crypto

def init_database():
    """Initialise la base de donn√©es et cr√©e toutes les tables"""
    print("üîß Initialisation de la base de donn√©es...")
    
    with app.app_context():
        # Cr√©er toutes les tables
        db.create_all()
        print("‚úÖ Tables cr√©√©es avec succ√®s!")
        
        # V√©rifier si des utilisateurs existent d√©j√†
        user_count = User.query.count()
        print(f"üë• Nombre d'utilisateurs existants: {user_count}")
        
        print("üéâ Base de donn√©es initialis√©e avec succ√®s!")

def reset_database():
    """Supprime et recr√©e toutes les tables"""
    print("üóëÔ∏è  R√©initialisation de la base de donn√©es...")
    
    with app.app_context():
        # Supprimer toutes les tables
        db.drop_all()
        print("‚úÖ Tables supprim√©es!")
        
        # Recr√©er les tables
        db.create_all()
        print("‚úÖ Nouvelles tables cr√©√©es!")
        
        print("üéâ Base de donn√©es r√©initialis√©e avec succ√®s!")

def show_database_info():
    """Affiche les informations de la base de donn√©es"""
    with app.app_context():
        user_count = User.query.count()
        crypto_count = Crypto.query.count()
        
        print("üìä Informations de la base de donn√©es:")
        print(f"   - Utilisateurs: {user_count}")
        print(f"   - Cryptomonnaies: {crypto_count}")
        
        if user_count > 0:
            print("\nüë• Utilisateurs existants:")
            for user in User.query.all():
                crypto_count_for_user = Crypto.query.filter_by(user_id=user.id).count()
                print(f"   - {user.username} ({user.email}) - {crypto_count_for_user} cryptos")

if __name__ == '__main__':
    import sys
    
    if len(sys.argv) > 1:
        command = sys.argv[1].lower()
        
        if command == 'init':
            init_database()
        elif command == 'reset':
            confirm = input("√ätes-vous s√ªr de vouloir supprimer toutes les donn√©es? (y/N): ")
            if confirm.lower() == 'y':
                reset_database()
            else:
                print("‚ùå Op√©ration annul√©e.")
        elif command == 'info':
            show_database_info()
        else:
            print("‚ùå Commande inconnue. Utilisez: init, reset, ou info")
    else:
        print("Usage:")
        print("  python init_db.py init    - Initialiser la base de donn√©es")
        print("  python init_db.py reset   - R√©initialiser la base de donn√©es")
        print("  python init_db.py info    - Afficher les informations de la base")